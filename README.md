# DOKDODAO Lottery Verification System

A CLI tool for independently verifying lottery results on the DOKDODAO platform.

## Overview

This tool verifies that lottery draws conducted on DOKDODAO campaigns or events were executed fairly.

- **Chainlink VRF** based verifiable random number generation
- **Merkle Tree** for participant data integrity verification
- Compare results against on-chain recorded data

## Installation

### From Source

```bash
# Clone the repository
git clone https://github.com/DOKDODAO/lottery-verification.git
cd lottery-verification

# Install dependencies
bun install

# Run directly
bun start <url>
```

### Pre-built Binaries

Download the latest release for your platform from the [Releases](https://github.com/DOKDODAO/lottery-verification/releases) page.

| Platform | Architecture | File |
|----------|--------------|------|
| Windows | x64 | `lottery-verification-win-x64.exe` |
| Linux | x64 | `lottery-verification-linux-x64` |
| Linux | ARM64 | `lottery-verification-linux-arm64` |
| macOS | Intel (x64) | `lottery-verification-macos-x64` |
| macOS | Apple Silicon (ARM64) | `lottery-verification-macos-arm64` |

## Usage

### Basic Command

```bash
# Using Bun
bun start <url>

# Using pre-built binary
./lottery-verification <url>
```

### Examples

```bash
# Verify an event
bun start https://www.dokdodao.io/events/145076508687994880

# Verify a campaign
bun start https://www.dokdodao.io/campaigns/136376065879314455

# Display help
bun start -h

# Display version
bun start -V
```

### Options

| Option | Description |
|--------|-------------|
| `-V, --version` | Output version information |
| `-h, --help` | Display help for command |

### Output Example

```
[INFO] Verifying lottery: events 145076508687994880
[INFO] Merkle root: 0x1234567890abcdef...
[INFO] 1st Place: 137177125719643403 (ticket #42)
[INFO] 2nd Place: 136773799807029658 (ticket #128)
[INFO] 2nd Place: 139719699848238255 (ticket #256)
...
```

### Verification Steps

1. Run the command with a DOKDODAO event or campaign URL
2. The tool fetches participant data from the API
3. Calculates the Merkle root and compares with on-chain data
4. Computes winners using the VRF random seed
5. Displays the verification results

## How It Works

### 1. Fetch Participant Data

Retrieves the participant list and ticket counts for each participant from the API.

### 2. Calculate Merkle Root

Computes the Merkle Root based on participant data and compares it with the on-chain recorded value.

```
Leaf = keccak256(abi.encodePacked(participantId, ticketStart, ticketEnd))
```

### 3. Winner Selection

Winners are determined using the random seed generated by Chainlink VRF.

```
ticketIndex = keccak256(abi.encodePacked(seed, drawIndex)) % totalTickets
```

- Duplicate prevention: Already selected participants are excluded from subsequent draws
- Number of winners per prize tier is determined by prizeConfig

### 4. Result Verification

Confirms that calculated results match the results recorded on-chain.

## Development

```bash
# Development mode (auto-restart on file changes)
bun dev

# Type check
bun run typecheck

# Build for current platform
bun run build

# Build for specific platforms
bun run build:windows
bun run build:linux
bun run build:linux-arm
bun run build:macos
bun run build:macos-arm
```

## Tech Stack

- **Runtime**: Bun
- **Language**: TypeScript
- **Blockchain**: ethers.js (keccak256, solidityPacked)
- **CLI**: Commander
- **Logging**: Pino
- **Validation**: Zod

## License

This source code is licensed under the DOKDODAO Source Available License.
See [LICENSE.md](LICENSE.md) for full terms.

## Author

SELVEDGE LAB PTE. LTD. (DOKDODAO)
Email: dokdo@dokdodao.io
